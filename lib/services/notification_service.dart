import 'dart:async';
import 'package:flutter/foundation.dart' show kIsWeb;
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:timezone/data/latest.dart' as tz_data;
import 'api_factory.dart';
import 'storage_service.dart';

// Import condicionalmente o dart:io apenas para plataformas n√£o-web
import 'dart:io' if (dart.library.html) 'platform_stub.dart' show Platform;

// Importa√ß√£o condicional para Android
import 'package:android_alarm_manager_plus/android_alarm_manager_plus.dart' if (dart.library.html) 'notification_service_web.dart';

class NotificationService {
  static final NotificationService _instance = NotificationService._internal();
  factory NotificationService() => _instance;
  NotificationService._internal();

  final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
      FlutterLocalNotificationsPlugin();

  // Estes campos s√£o usados apenas nos m√©todos est√°ticos via inst√¢ncias locais

  // IDs para os alarmes
  static const int atualizacaoFaltasId = 1;
  static const int lembreteFaltasId = 2;

  Future<void> init() async {
    tz_data.initializeTimeZones();

    // Inicializa as notifica√ß√µes locais
    final InitializationSettings initializationSettings;
    
    if (1==1) { //!kIsWeb && Platform.isAndroid
      const AndroidInitializationSettings initializationSettingsAndroid =
          AndroidInitializationSettings('@mipmap/ic_launcher');
      initializationSettings = const InitializationSettings(
        android: initializationSettingsAndroid,
      );
    } else {
      // Para web e outras plataformas, usar configura√ß√µes vazias
      initializationSettings = const InitializationSettings();
    }

    await flutterLocalNotificationsPlugin.initialize(
      initializationSettings,
    );

    // S√≥ configura alarmes no Android
    if (1==1) { //!kIsWeb && Platform.isAndroid
      // Inicializa o gerenciador de alarmes
      await AndroidAlarmManager.initialize();

      // Agenda as tarefas recorrentes
      await configurarAtualizacaoAutomatica();
      await configurarLembreteDiario();
    }
  }

  // Configura a atualiza√ß√£o autom√°tica das faltas com hor√°rio personaliz√°vel
  Future<void> configurarAtualizacaoAutomatica() async {
    final storageService = StorageService();
    final settings = await storageService.getNotificationSettings();
    
    // Se as notifica√ß√µes estiverem desativadas, n√£o agenda
    if (!settings.notificacoesAtivas) return;
    
    final DateTime agora = DateTime.now();
    final DateTime horarioAtualizacao = DateTime(
      agora.year,
      agora.month,
      agora.day,
      settings.atualizacaoHora,
      settings.atualizacaoMinuto,
    );

    // Se o hor√°rio j√° passou hoje, agenda para amanh√£
    final DateTime horarioEfetivo = agora.isAfter(horarioAtualizacao)
        ? horarioAtualizacao.add(const Duration(days: 1))
        : horarioAtualizacao;

    await AndroidAlarmManager.periodic(
      const Duration(days: 1),
      atualizacaoFaltasId,
      _atualizarFaltasCallback,
      startAt: horarioEfetivo,
      exact: true,
      wakeup: true,
      rescheduleOnReboot: true,
    );
  }

  // Configura o lembrete di√°rio com hor√°rio personaliz√°vel
  Future<void> configurarLembreteDiario() async {
    final storageService = StorageService();
    final settings = await storageService.getNotificationSettings();
    
    // Se as notifica√ß√µes estiverem desativadas, n√£o agenda
    if (!settings.notificacoesAtivas) return;
    
    final DateTime agora = DateTime.now();
    final DateTime horarioLembrete = DateTime(
      agora.year,
      agora.month,
      agora.day,
      settings.lembreteHora,
      settings.lembreteMinuto,
    );

    // Se o hor√°rio j√° passou hoje, agenda para amanh√£
    final DateTime horarioEfetivo = agora.isAfter(horarioLembrete)
        ? horarioLembrete.add(const Duration(days: 1))
        : horarioLembrete;

    await AndroidAlarmManager.periodic(
      const Duration(days: 1),
      lembreteFaltasId,
      _lembreteCallback,
      startAt: horarioEfetivo,
      exact: true,
      wakeup: true,
      rescheduleOnReboot: true,
    );
  }

  // Callback para atualiza√ß√£o das faltas (executado em segundo plano)
  @pragma('vm:entry-point')
  static Future<void> _atualizarFaltasCallback() async {
    final storageService = StorageService();
    final apiFactory = ApiFactory();
    final apiService = apiFactory.getApi();

    try {
      // Obt√©m o cookie salvo
      final cookie = await storageService.getCookie();
      if (cookie != null && cookie.isValid()) {
        // Busca as faltas atualizadas
        final faltas = await apiService.buscarFaltas(cookie.cookie);
        await storageService.saveFaltas(faltas);

        // Envia uma notifica√ß√£o informando que os dados foram atualizados
        await _mostrarNotificacao(
          'Faltas Atualizadas',
          'Seus dados de faltas foram atualizados automaticamente.',
        );
      }
    } catch (e) {
      print('Erro ao atualizar faltas: $e');
    }
  }

  // Callback para o lembrete di√°rio (executado em segundo plano)
  @pragma('vm:entry-point')
  static Future<void> _lembreteCallback() async {
    final storageService = StorageService();

    try {
      // Obt√©m o hor√°rio salvo
      final horario = await storageService.getHorario();

      if (horario != null) {
        final hoje = DateTime.now().weekday;
        
        // Se for fim de semana, n√£o envia notifica√ß√£o
        if (hoje > 5) {
          return;
        }
        
        final podeFaltarHoje = horario.getFaltasRestantes(hoje);
        final materias = horario.getMateriasDoDia(hoje);
        
        // Texto personalizado para o lembrete de faltas
        String mensagem;
        if (podeFaltarHoje == 0) {
          mensagem = '‚ö†Ô∏è Aten√ß√£o! Voc√™ n√£o pode faltar hoje nas aulas de $materias.';
        } else if (podeFaltarHoje == 1) {
          mensagem = 'üìö Lembrete: Voc√™ s√≥ pode faltar mais 1 vez hoje nas aulas de $materias. Aproveite bem sua presen√ßa!';
        } else {
          mensagem = 'üìö Lembrete: Voc√™ pode faltar at√© $podeFaltarHoje vezes hoje nas aulas de $materias.';
        }

        // Envia uma notifica√ß√£o com as informa√ß√µes do dia
        await _mostrarNotificacao(
          'Lembrete de Faltas Dispon√≠veis',
          mensagem,
        );
      }
    } catch (e) {
      print('Erro ao mostrar lembrete: $e');
    }
  }

  // Fun√ß√£o auxiliar para mostrar notifica√ß√µes
  static Future<void> _mostrarNotificacao(String titulo, String corpo) async {
    final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
        FlutterLocalNotificationsPlugin();

    const AndroidNotificationDetails androidPlatformChannelSpecifics =
        AndroidNotificationDetails(
      'faltas_channel',
      'Faltas',
      channelDescription: 'Notifica√ß√µes sobre faltas',
      importance: Importance.high,
      priority: Priority.high,
    );

    const NotificationDetails platformChannelSpecifics =
        NotificationDetails(android: androidPlatformChannelSpecifics);

    await flutterLocalNotificationsPlugin.show(
      0,
      titulo,
      corpo,
      platformChannelSpecifics,
    );
  }

  // M√©todo para mostrar notifica√ß√£o imediatamente (para testes)
  Future<void> mostrarNotificacaoTeste() async {
    if (1==1) { //!kIsWeb && (Platform.isAndroid || Platform.isIOS || Platform.isMacOS)) {
      await _mostrarNotificacao(
        'Teste de Notifica√ß√£o',
        'Esta √© uma notifica√ß√£o de teste.',
      );
      print('FOI.');
    } else {
      // Em plataformas n√£o suportadas, apenas imprime no console
      print('Notifica√ß√£o de teste (plataforma n√£o suportada): Esta √© uma notifica√ß√£o de teste.');
    }
  }
  
  // M√©todo para reconfigurar as notifica√ß√µes ap√≥s mudan√ßa nas configura√ß√µes
  Future<void> reconfigurarNotificacoes() async {
    if (!kIsWeb && Platform.isAndroid) {
      // Cancela os alarmes existentes
      await AndroidAlarmManager.cancel(atualizacaoFaltasId);
      await AndroidAlarmManager.cancel(lembreteFaltasId);
      
      // Reconfigura com os novos hor√°rios
      await configurarAtualizacaoAutomatica();
      await configurarLembreteDiario();
    }
  }
}
